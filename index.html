<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×¡×™×›×•× ×©×™×—×”</title>
<style>
body{
  direction:rtl;
  font-family:Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.box{
  background:#fff;
  max-width:900px;
  margin:auto;
  padding:20px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
h2{margin-top:0;margin-bottom:16px;}
label{font-weight:bold;display:block;margin-bottom:6px}
#step{
  max-width:420px;
  margin:0 auto 10px;
}
input,select{
  width:100%;
  padding:10px;
  font-size:16px;
  margin-bottom:12px;
  box-sizing:border-box;
}
button{
  cursor:pointer;
  font-size:15px;
  padding:8px 14px;
  margin-bottom:0;
  width:auto;
  border-radius:8px;
  border:1px solid #ccc;
  background:#fafafa;
}
button.primary{
  background:#1976d2;
  border-color:#1976d2;
  color:#fff;
}
button.secondary{
  background:#eee;
}
.btn-row{
  max-width:420px;
  margin:4px auto 0;
  display:flex;
  gap:8px;
  justify-content:flex-start;
}
pre{
  background:#eee;
  padding:12px;
  white-space:pre-wrap;
  border-radius:8px;
  max-height:60vh;
  overflow:auto;
}
#copyBtn,#resetBtn{
  margin-top:8px;
}
</style>
</head>
<body>

<div class="box">
  <h2 id="title">×¡×™×›×•× ×©×™×—×”</h2>

  <div id="step"></div>

  <div class="btn-row">
    <button id="backBtn" class="secondary" style="display:none">×—×–×¨×”</button>
    <button id="nextBtn" class="primary">×”××©×š</button>
  </div>

  <pre id="output" style="display:none"></pre>
  <button id="copyBtn" style="display:none" class="primary">ğŸ“‹ ×”×¢×ª×§</button>
  <button id="resetBtn" class="secondary" style="display:none">×¡×™×•×</button>
</div>

<script>
/* ========= ×§×‘×•×¢×™× ========= */

const ACTIONS = ["× ×™×•×“","×”×©××¨×”","×¤×ª×™×—×ª ×§×•×¤×”","×¤×¨×˜"];

const INVESTMENT_COMPANIES = [
 "×”×¨××œ","×›×œ×œ","×”×¤× ×™×§×¡","××’×“×œ","××•×¨",
 "××œ×˜×©×•×œ×¨ ×©×—×","×× ×œ×™×¡×˜","×™×œ×™×Ÿ ×œ×¤×™×“×•×ª","××™× ×¤×™× ×™×˜×™","××™×˜×‘","×× ×•×¨×”"
];

const INSURANCE_COMPANIES = [
 "×”×¨××œ","××’×“×œ","×× ×•×¨×”","×”×¤× ×™×§×¡","×”×›×©×¨×”","×‘×™×˜×•×— ×™×©×™×¨","×›×œ×œ","××™×™×œ×•×Ÿ"
];

const FUND_TYPES = [
 "×§×¨×Ÿ ×¤× ×¡×™×”",
 "×§×¨×Ÿ ×”×©×ª×œ××•×ª",
 "×§×•×¤×ª ×’××œ",
 "×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”",
 "×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ"
];

const EMP_STATUS = ["×©×›×™×¨×”","×¢×¦×××™×ª","×›×œ×•×"];

const TRACKS = [
 "×× ×™×•×ª","Snp500","××©×•×œ×‘ ×¡×—×™×¨","×¢×•×§×‘ ××“×“×™× ×’××™×©",
 "×× ×™×•×ª ×¡×—×™×¨","×¢×•×§×‘ ××“×“×™ ×× ×™×•×ª",
 "50% ×× ×™×•×ª 50% snp500",
 "×”×©×œ×•×© ×”×§×“×•×©","×—×¦×™ ×—×¦×™ ×× ×œ×™×¡×˜"
];

// ×“××™ × ×™×”×•×œ ×œ×¤×™ ×¡×•×’ ××•×¦×¨
const FUND_FEES = ["0.6%","0.7%","0.8%"];
const PENSION_FEES = [
 "0.1% ××¦×‘×™×¨×” ×•×¢×•×“ 1.5% ××”×¤×§×“×”",
 "0.15% ××¦×‘×™×¨×” ×•×¢×•×“ 1.5% ××”×¤×§×“×”"
];

const PRIVATE_POLICIES = [
 "×¤×•×œ×™×¡×ª ××©×›× ×ª×",
 "×¤×•×œ×™×¡×ª ×—×™×™×",
 "×¤×•×œ×™×¡×ª ×—×™×™× ××©×•×¢×‘×“×ª",
 "×‘×™×˜×•×— ×‘×¨×™××•×ª",
 "×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª"
];

const PRIVATE_ACTIONS = [
 "×œ×‘×˜×œ",
 "×œ×”×©××™×¨",
 "×œ×”×¤×™×§ ×—×“×©",
 "×”×¤×§×” ×•×‘×™×˜×•×œ",
 "××™× ×•×™ ×¡×•×›×Ÿ"
];

const KGI_PAY_OPTIONS = ["××™×Ÿ","×”×•×¨××ª ×§×‘×¢","×”×¢×‘×¨×” ×—×“ ×¤×¢××™×ª"];

/* ========= ××¦×‘ ========= */

let total = 0;
let current = 1;
let data = {};
let results = [];
let flow = [];
let flowIndex = 0;
let currentStepIndex = -1;

// ×¡×™×›×•× ××• ×”××œ×¦×•×ª
let summaryMode = "×¡×™×›×•×";

const lettersHeb = "××‘×’×“×”×•×–×—×˜×™×›×œ×× ×¡×¢×¤×¦×§×¨×©×ª".split("");

/* ========= ××œ×× ×˜×™× ========= */

const step = document.getElementById("step");
const title = document.getElementById("title");
const nextBtn = document.getElementById("nextBtn");
const backBtn = document.getElementById("backBtn");
const output = document.getElementById("output");
const copyBtn = document.getElementById("copyBtn");
const resetBtn = document.getElementById("resetBtn");

/* ========= ×”×ª×—×œ×” ========= */

askSelect("×”×× ×–×” ×¡×™×›×•× ×©×œ ×”×“×‘×¨×™× ××• ×”××œ×¦×•×ª?","summaryModeChoice",["×¡×™×›×•× ×”×“×‘×¨×™×","×”××œ×¦×•×ª"], ()=>{
  summaryMode = (data.summaryModeChoice === "×”××œ×¦×•×ª") ? "×”××œ×¦×•×ª" : "×¡×™×›×•×";
  askInput("×›××” ×¤×¢×•×œ×•×ª ×¦×¨×™×š ×œ×¨×©×•×?","count",true);
});

/* ========= UI ========= */

function updateTitle(){
  title.textContent = total>1 ? `×¤×¢×•×œ×” ${current} ××ª×•×š ${total}` : "×¡×™×›×•× ×©×™×—×”";
}

function setupBackButton(inFlow){
  if(inFlow && flow && flow.length>0 && currentStepIndex>0){
    backBtn.style.display = "inline-block";
    backBtn.onclick = ()=>{
      const prevIndex = Math.max(0, currentStepIndex-1);
      currentStepIndex = prevIndex;
      flowIndex = prevIndex+1;
      flow[prevIndex]();
    };
  } else {
    backBtn.style.display = "none";
    backBtn.onclick = null;
  }
}

/* ========= ×©×“×•×ª ========= */

function askInput(label,key,isFirst=false,done){
  updateTitle();
  const inFlow = (flow && flow.length>0);
  setupBackButton(inFlow);

  const prev = data[key] || "";
  step.innerHTML = `<label>${label}</label><input id="value" value="${prev}">`;

  nextBtn.onclick = ()=>{
    const v = value.value.trim();
    if(isFirst){
      total = parseInt(v,10);
      if(!Number.isFinite(total) || total<=0) return alert("××¡×¤×¨ ×œ× ×ª×§×™×Ÿ");
      data = {};
      chooseAction();
      return;
    }
    if(!v) return alert("×™×© ×œ××œ×");
    data[key]=v;
    done ? done() : nextInFlow();
  };
}

function askSelect(label,key,options,done){
  updateTitle();
  const inFlow = (flow && flow.length>0);
  setupBackButton(inFlow);

  const prev = data[key] || options[0];
  step.innerHTML = `<label>${label}</label>
  <select id="value">
    ${options.map(o=>`<option ${o===prev?'selected':''}>${o}</option>`).join("")}
  </select>`;
  nextBtn.onclick = ()=>{
    data[key]=value.value;
    done ? done() : nextInFlow();
  };
}

function askSelectWithOther(label,key,options,done){
  updateTitle();
  const inFlow = (flow && flow.length>0);
  setupBackButton(inFlow);

  const prevVal = data[key] || "";
  const all = options.concat(["××—×¨"]);
  let selectInit = all.includes(prevVal) ? prevVal : "××—×¨";
  let otherInit = all.includes(prevVal) ? "" : (prevVal || "");

  step.innerHTML = `
    <label>${label}</label>
    <select id="value">
      ${all.map(o=>`<option ${o===selectInit?'selected':''}>${o}</option>`).join("")}
    </select>
    <div id="otherBox" style="display:none"></div>
  `;
  const sel = document.getElementById("value");
  const otherBox = document.getElementById("otherBox");

  function refreshOther(){
    if(sel.value==="××—×¨"){
      otherBox.style.display="block";
      otherBox.innerHTML=`<label>××œ×œ ×—×•×¤×©×™</label><input id="otherValue" value="${otherInit}">`;
    } else {
      otherBox.style.display="none";
      otherBox.innerHTML="";
    }
  }
  sel.onchange = ()=>{ otherInit=""; refreshOther(); };
  refreshOther();

  nextBtn.onclick = ()=>{
    if(sel.value==="××—×¨"){
      const ov = document.getElementById("otherValue");
      const v = (ov?.value || "").trim();
      if(!v) return alert("×™×© ×œ××œ× ××œ×œ ×—×•×¤×©×™");
      data[key]=v;
    }else{
      data[key]=sel.value;
    }
    done ? done() : nextInFlow();
  };
}

/* ========= ×–×¨×™××” ========= */

function chooseAction(){
  askSelect("××” ×¡×•×’ ×”×¤×¢×•×œ×”?","action",ACTIONS,()=>{
    buildFlow();
    nextInFlow();
  });
}

function nextInFlow(){
  if(flowIndex < flow.length){
    currentStepIndex = flowIndex;
    const fn = flow[flowIndex];
    flowIndex += 1;
    fn();
  }
}

function buildFlow(){
  flow=[]; flowIndex=0; currentStepIndex=-1;

  /* ---- × ×™×•×“ ---- */
  if(data.action==="× ×™×•×“"){
    flow=[
      ()=>askSelectWithOther("××” ×©× ×”×—×‘×¨×” ×”× ×•×›×—×™×ª?","company",INVESTMENT_COMPANIES),
      ()=>askSelectWithOther("××” ×¡×•×’ ×”×§×•×¤×”?","fundType",FUND_TYPES),
      ()=>{
        if(["×§×¨×Ÿ ×¤× ×¡×™×”","×§×¨×Ÿ ×”×©×ª×œ××•×ª","×§×•×¤×ª ×’××œ"].includes(data.fundType)){
          askSelect("×”×× ×©×›×™×¨×” / ×¢×¦×××™×ª / ×›×œ×•×?","empStatus",EMP_STATUS);
        } else nextInFlow();
      },
      ()=>{
        if(data.empStatus==="×©×›×™×¨×”"){
          askInput("××” ×©× ×”××¢×¡×™×§?","employer");
        } else if(data.empStatus==="×¢×¦×××™×ª"){
          askInput("×›××” ×œ×”×¤×§×™×“?","selfAmount");
        } else nextInFlow();
      },
      ()=>askInput("××” ××¡×¤×¨ ×”×§×•×¤×”?","fundNumber"),
      ()=>askSelectWithOther("×œ××™×–×• ×—×‘×¨×” ×œ× ×™×™×“?","targetCompany",INVESTMENT_COMPANIES),
      ()=>askSelectWithOther("××” ××¡×œ×•×œ ×”×”×©×§×¢×”?","investment",TRACKS),
      ()=>askFees(save)
    ];
  }

  /* ---- ×”×©××¨×” ---- */
  if(data.action==="×”×©××¨×”"){
    flow=[
      ()=>askSelectWithOther("××” ×©× ×”×—×‘×¨×”?","company",INVESTMENT_COMPANIES),
      ()=>askSelectWithOther("××” ×¡×•×’ ×”×§×•×¤×”?","fundType",FUND_TYPES),
      ()=>{
        if(["×§×¨×Ÿ ×¤× ×¡×™×”","×§×¨×Ÿ ×”×©×ª×œ××•×ª","×§×•×¤×ª ×’××œ"].includes(data.fundType)){
          askSelect("×”×× ×©×›×™×¨×” / ×¢×¦×××™×ª / ×›×œ×•×?","empStatus",EMP_STATUS);
        } else nextInFlow();
      },
      ()=>{
        if(data.empStatus==="×©×›×™×¨×”"){
          askInput("××” ×©× ×”××¢×¡×™×§?","employer");
        } else if(data.empStatus==="×¢×¦×××™×ª"){
          askInput("×›××” ×œ×”×¤×§×™×“?","selfAmount");
        } else nextInFlow();
      },
      ()=>askInput("××” ××¡×¤×¨ ×”×§×•×¤×”?","fundNumber"),
      ()=>askSelect("××” ×¡×•×’ ×”×¤×¢×•×œ×”?","stayAction",["×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”","××™× ×•×™ ×¡×•×›×Ÿ","×œ×œ× ×©×™× ×•×™"],()=>{
        if(data.stayAction==="×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”") nextInFlow();
        else save();
      }),
      ()=>askSelectWithOther("××” ×”××¡×œ×•×œ ×”× ×•×›×—×™?","currentInvestment",TRACKS),
      ()=>askSelectWithOther("×œ××™×–×” ××¡×œ×•×œ ×™×¢×‘×•×¨?","futureInvestment",TRACKS,save)
    ];
  }

  /* ---- ×¤×ª×™×—×ª ×§×•×¤×” ---- */
  if(data.action==="×¤×ª×™×—×ª ×§×•×¤×”"){
    flow=[
      ()=>askSelectWithOther("××” ×¡×•×’ ×”××•×¦×¨?","fundType",FUND_TYPES),
      ()=>{
        if(["×§×¨×Ÿ ×¤× ×¡×™×”","×§×¨×Ÿ ×”×©×ª×œ××•×ª","×§×•×¤×ª ×’××œ"].includes(data.fundType)){
          askSelect("×”×× ×©×›×™×¨×” / ×¢×¦×××™×ª / ×›×œ×•×?","empStatus",EMP_STATUS);
        } else nextInFlow();
      },
      ()=>{
        if(data.empStatus==="×©×›×™×¨×”"){
          askInput("××” ×©× ×”××¢×¡×™×§?","employer");
        } else if(data.empStatus==="×¢×¦×××™×ª"){
          askInput("×›××” ×œ×”×¤×§×™×“?","selfAmount");
        } else nextInFlow();
      },
      ()=>askSelectWithOther("××” ×©× ×”×—×‘×¨×”?","company",INVESTMENT_COMPANIES),
      ()=>askSelectWithOther("××” ××¡×œ×•×œ ×”×”×©×§×¢×”?","investment",TRACKS),
      ()=>askFees(()=>{
        if(data.fundType==="×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"){
          nextInFlow();
        } else {
          save();
        }
      }),
      ()=>{
        if(data.fundType==="×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"){
          askSelect("×‘×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”: ×”×× ×™×© ×”×•×¨××ª ×§×‘×¢ / ×”×¢×‘×¨×” ×—×“ ×¤×¢××™×ª / ×›×œ×•×?","kgiPayType",KGI_PAY_OPTIONS,()=>{
            if(data.kgiPayType==="×”×•×¨××ª ×§×‘×¢"){
              askInput("××” ×”×¡×›×•× (×œ×“×•×’××” 1000)?","kgiAmount",false,save);
            } else if(data.kgiPayType==="×”×¢×‘×¨×” ×—×“ ×¤×¢××™×ª"){
              askInput("××” ×”×¡×›×•× (×œ×“×•×’××” 10000)?","kgiAmount",false,save);
            } else {
              save();
            }
          });
        } else {
          save();
        }
      }
    ];
  }

  /* ---- ×¤×¨×˜ ---- */
  if(data.action==="×¤×¨×˜"){
    flow=[
      ()=>askSelectWithOther("××” ×¡×•×’ ×”×¤×•×œ×™×¡×”?","policyType",PRIVATE_POLICIES),
      ()=>{
        if(["×¤×•×œ×™×¡×ª ×—×™×™×","×‘×™×˜×•×— ×‘×¨×™××•×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª"].includes(data.policyType)){
          askInput("××”×• ×¡×›×•× ×”×‘×™×˜×•×—?","insuranceSum");
        } else nextInFlow();
      },
      ()=>askSelect("××” ×œ×‘×¦×¢ ×‘×¤×•×œ×™×¡×”?","policyAction",PRIVATE_ACTIONS),
      ()=>{
        const lbl = (data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ")
                    ? "××” ×©× ×—×‘×¨×ª ×”×‘×™×˜×•×— (×”×¤×•×œ×™×¡×” ×”×§×™×™××ª)?"
                    : "××” ×©× ×—×‘×¨×ª ×”×‘×™×˜×•×—?";
        askSelectWithOther(lbl,"company",INSURANCE_COMPANIES);
      },
      ()=>{
        if(data.policyAction==="×œ×”×¤×™×§ ×—×“×©"){
          askInput("××” ×”×¤×¨××™×” ×”×—×•×“×©×™×ª?","monthlyPremium",false,save);
        } else if(data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ"){
          askInput("××” ××¡×¤×¨ ×”×¤×•×œ×™×¡×” ×©×ª×ª×‘×˜×œ?","policyNumber",false,()=>nextInFlow());
        } else {
          askInput("××” ××¡×¤×¨ ×”×¤×•×œ×™×¡×”?","policyNumber",false,save);
        }
      },
      ()=>{
        if(data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ"){
          askSelectWithOther("××” ×¡×•×’ ×”×‘×™×˜×•×— ×”×—×“×© ×©×™×•×¤×§?","newPolicyType",PRIVATE_POLICIES);
        } else {
          save();
        }
      },
      ()=>{
        if(data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ"){
          askSelectWithOther("×‘××™×–×• ×—×‘×¨×ª ×‘×™×˜×•×— ×ª×•×¤×§ ×”×¤×•×œ×™×¡×” ×”×—×“×©×”?","newCompany",INSURANCE_COMPANIES);
        } else {
          save();
        }
      },
      ()=>{
        if(data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ"){
          askInput("××” ×”×¤×¨××™×” ×”×—×•×“×©×™×ª ×œ×¤×•×œ×™×¡×” ×”×—×“×©×”?","newMonthlyPremium",false,save);
        } else {
          save();
        }
      }
    ];
  }
}

/* ========= ×“××™ × ×™×”×•×œ ========= */

function askFees(done){
  const label = "××” ×“××™ ×”× ×™×”×•×œ?";
  if(data.fundType === "×§×¨×Ÿ ×¤× ×¡×™×”"){
    askSelectWithOther(label,"fees",PENSION_FEES,done);
  }
  else if(["×§×¨×Ÿ ×”×©×ª×œ××•×ª","×§×•×¤×ª ×’××œ","×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”","×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ"].includes(data.fundType)){
    askSelectWithOther(label,"fees",FUND_FEES,done);
  }
  else{
    askSelectWithOther(label,"fees",[],done);
  }
}

/* ========= ×¢×–×¨×™× ========= */

function normalizeTrack(t){
  if(t==="×”×©×œ×•×© ×”×§×“×•×©") return "33% ××©×•×œ×‘ ×¡×—×™×¨ 33% ××“×“×™ ×× ×™×•×ª 34% snp500";
  if(t==="×—×¦×™ ×—×¦×™ ×× ×œ×™×¡×˜") return "50% ×¢×•×§×‘ ××“×“×™× ×’××™×© 50% snp500";
  return t;
}

function empTextMiddle(){
  if(data.empStatus==="×©×›×™×¨×”") return ` ×©×›×™×¨×” ×ª×—×ª ×”××¢×¡×™×§ ${data.employer}`;
  if(data.empStatus==="×¢×¦×××™×ª") return ` ×¢×¦×××™×ª`;
  return "";
}

function selfDepositSuffix(){
  if(data.empStatus==="×¢×¦×××™×ª" && data.selfAmount){
    return ` ×¢× ×”×¤×§×“×” ×—×•×“×©×™×ª ×©×œ ${data.selfAmount} â‚ª`;
  }
  return "";
}

function needInsuranceSum(){
  return ["×¤×•×œ×™×¡×ª ×—×™×™×","×‘×™×˜×•×— ×‘×¨×™××•×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª"].includes(data.policyType);
}

function insuranceSumText(){
  if(needInsuranceSum() && data.insuranceSum){
    return ` ×‘×¡×›×•× ×‘×™×˜×•×— ×©×œ ${data.insuranceSum} â‚ª`;
  }
  return "";
}

function advanceToNextAction(){
  if(current < total){
    current++;
    data={};
    flow=[]; flowIndex=0; currentStepIndex=-1;
    chooseAction();
  } else {
    finish();
  }
}

/* ========= × ×™××•×§×™× ×œ×”××œ×¦×” ========= */

function askReasonsForRecommendation(baseLine){
  updateTitle();
  setupBackButton(false);

  step.innerHTML = `
    <label>×œ×”×œ×Ÿ ×”×¡×™×‘×•×ª ×œ×”××œ×¦×” ×–××ª (× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××” × ×™××•×§×™×):</label>
    <div id="reasonsList" style="margin-bottom:8px;font-size:14px;"></div>
    <input id="reasonInput" placeholder="× ×™××•×§ ××—×“ ×‘×›×œ ×¤×¢×">
    <div style="margin-top:6px;">
      <button type="button" id="addReasonBtn" class="secondary">× ×™××•×§ × ×•×¡×£</button>
    </div>
  `;

  const reasons = [];
  const listDiv = document.getElementById("reasonsList");
  const inputEl = document.getElementById("reasonInput");
  const addBtn = document.getElementById("addReasonBtn");

  function renderList(){
    if(reasons.length===0){
      listDiv.textContent = "(×˜×¨× × ×¨×©××• × ×™××•×§×™×)";
      return;
    }
    if(reasons.length===1){
      listDiv.innerHTML = reasons[0];
    } else {
      const html = reasons.map((r,i)=>`${lettersHeb[i]}. ${r}`).join("<br>");
      listDiv.innerHTML = html;
    }
  }
  renderList();

  addBtn.onclick = ()=>{
    const v = inputEl.value.trim();
    if(!v) return alert("×¨×©×•× × ×™××•×§ ×œ×¤× ×™ ×”×•×¡×¤×”");
    reasons.push(v);
    inputEl.value="";
    renderList();
  };

  nextBtn.onclick = ()=>{
    const v = inputEl.value.trim();
    if(v){
      reasons.push(v);
      inputEl.value="";
    }

    let finalLine = baseLine;

    // ×œ×•×•×“× ×©×™×© × ×§×•×“×” ×‘×¡×•×£ ××©×¤×˜ ×”×”××œ×¦×”
    const trimmed = finalLine.trim();
    if(!trimmed.endsWith(".") && !trimmed.endsWith("!") && !trimmed.endsWith("?")){
      finalLine += ".";
    }

    if(reasons.length>0){
      finalLine += "\n\n×œ×”×œ×Ÿ ×”×¡×™×‘×•×ª ×œ×”××œ×¦×” ×–××ª:\n";
      if(reasons.length===1){
        finalLine += reasons[0] + "\n";
      } else {
        finalLine += reasons.map((r,i)=>`${lettersHeb[i]}. ${r}`).join("\n") + "\n";
      }
    }

    results.push(finalLine);
    advanceToNextAction();
  };
}

/* ========= ×©××™×¨×” ========= */

function save(){
  let prefix = total>1 ? `${current}. ` : "";
  let line = prefix;

  /* ---- × ×™×•×“ ---- */
  if(data.action==="× ×™×•×“"){
    line += `${data.company} ${data.fundType}${empTextMiddle()} ××¡×¤×¨ ×§×•×¤×” ${data.fundNumber}- ×ª× ×•×™×“ ×œ×—×‘×¨×ª ${data.targetCompany} ×›××©×¨ ×”×›×¡×£ ×™×•×©×§×¢ ×‘××¡×œ×•×œ ×”×©×§×¢×” ${normalizeTrack(data.investment)} ×‘×“××™ × ×™×”×•×œ ${data.fees}`;
    line += selfDepositSuffix();
  }

  /* ---- ×”×©××¨×” ---- */
  if(data.action==="×”×©××¨×”"){
    if(data.stayAction==="×œ×œ× ×©×™× ×•×™"){
      line += `${data.company} ${data.fundType}${empTextMiddle()} ××¡×¤×¨ ×§×•×¤×” ${data.fundNumber} â€“ ×ª×™×©××¨ ×œ×œ× ×©×™× ×•×™`;
    } else if(data.stayAction==="××™× ×•×™ ×¡×•×›×Ÿ"){
      line += `${data.company} ${data.fundType}${empTextMiddle()} ××¡×¤×¨ ×§×•×¤×” ${data.fundNumber} â€“ ××™× ×•×™ ×¡×•×›×Ÿ`;
    } else {
      line += `${data.company} ${data.fundType}${empTextMiddle()} ××¡×¤×¨ ×§×•×¤×” ${data.fundNumber} â€“ ×ª×™×©××¨ ×‘××•×ª×” ×—×‘×¨×” ×›××©×¨ ×™×ª×‘×¦×¢ ×©×™× ×•×™ ××¡×œ×•×œ ×${normalizeTrack(data.currentInvestment)} ×œ${normalizeTrack(data.futureInvestment)}`;
    }
    line += selfDepositSuffix();
  }

  /* ---- ×¤×ª×™×—×ª ×§×•×¤×” ---- */
  if(data.action==="×¤×ª×™×—×ª ×§×•×¤×”"){
    line += `×¤×ª×™×—×ª ${data.fundType}${empTextMiddle()} ×‘×—×‘×¨×ª ${data.company} ×›××©×¨ ×”×›×¡×£ ×™×•×©×§×¢ ×‘××¡×œ×•×œ ×”×©×§×¢×” ${normalizeTrack(data.investment)} ×‘×“××™ × ×™×”×•×œ ${data.fees}`;

    if(data.fundType==="×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”" && data.kgiPayType && data.kgiPayType!=="××™×Ÿ"){
      const amt = (data.kgiAmount || "").trim();
      if(data.kgiPayType==="×”×•×¨××ª ×§×‘×¢"){
        line += ` ×¢× ×”×•×¨××ª ×§×‘×¢ ×‘×¡×›×•× ×©×œ ${amt} â‚ª ×‘×—×•×“×©`;
      } else if(data.kgiPayType==="×”×¢×‘×¨×” ×—×“ ×¤×¢××™×ª"){
        line += ` ×¢× ×”×¢×‘×¨×” ×—×“ ×¤×¢××™×ª ×‘×¡×›×•× ×©×œ ${amt} â‚ª`;
      }
    }

    if(data.fundType!=="×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"){
      line += selfDepositSuffix();
    }
  }

  /* ---- ×¤×¨×˜ ---- */
  if(data.action==="×¤×¨×˜"){
    if(data.policyAction==="××™× ×•×™ ×¡×•×›×Ÿ"){
      line += `${data.policyType} ×‘×—×‘×¨×ª ${data.company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${data.policyNumber}- ×™×ª×‘×¦×¢ ××™× ×•×™ ×¡×•×›×Ÿ`;
      line += insuranceSumText();
    } else if(data.policyAction==="×œ×‘×˜×œ"){
      line += `${data.policyType} ×‘×—×‘×¨×ª ${data.company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${data.policyNumber}- ×ª×‘×•×˜×œ`;
      line += insuranceSumText();
    } else if(data.policyAction==="×œ×”×©××™×¨"){
      line += `${data.policyType} ×‘×—×‘×¨×ª ${data.company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${data.policyNumber}- ×ª×™×©××¨`;
      line += insuranceSumText();
    } else if(data.policyAction==="×”×¤×§×” ×•×‘×™×˜×•×œ"){
      line += `${data.policyType} ×‘×—×‘×¨×ª ${data.company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${data.policyNumber}- ×¤×•×œ×™×¡×” ×–×• ×ª×ª×‘×˜×œ ×•×‘××§×•× ×–×” ×ª×•×¤×§ ×¤×•×œ×™×¡×ª ${data.newPolicyType} ×‘${data.newCompany} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${data.newMonthlyPremium} â‚ª`;
    } else {
      // ×”×¤×§×” ×—×“×©×” ×‘×œ×‘×“
      if (["×‘×™×˜×•×— ×‘×¨×™××•×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª"].includes(data.policyType) && data.insuranceSum){
        line += `×ª×•×¤×§ ×¤×•×œ×™×¡×” ×—×“×©×” ×©×œ ${data.policyType} ×¢× ×¤×™×¦×•×™ ×©×œ ${data.insuranceSum} â‚ª ×‘×—×‘×¨×ª ${data.company} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${data.monthlyPremium} â‚ª`;
      } else {
        line += `×ª×•×¤×§ ×¤×•×œ×™×¡×” ×—×“×©×” ×©×œ ${data.policyType} ×‘×—×‘×¨×ª ${data.company} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${data.monthlyPremium} â‚ª`;
        line += insuranceSumText();
      }
    }
  }

  if(summaryMode === "×”××œ×¦×•×ª"){
    // ××¢×‘×¨ ×œ××¡×š × ×™××•×§×™× ×¢× ×›×¤×ª×•×¨ "× ×™××•×§ × ×•×¡×£"
    askReasonsForRecommendation(line);
  } else {
    results.push(line);
    advanceToNextAction();
  }
}

/* ========= ×¡×™×•× ========= */

function finish(){
  let header;
  if(summaryMode === "×”××œ×¦×•×ª"){
    header = `×‘×”××©×š ×œ×©×™×—×ª× ×•\n×œ×”×œ×Ÿ ×”×”××œ×¦×•×ª ×©× ×××¨×• ×‘×©×™×—×”:\n\n`;
  } else {
    header = `×‘×”××©×š ×œ×©×™×—×ª× ×•\n×¡×•×›× ×¢×œ ×”×“×‘×¨×™× ×”×‘××™×:\n\n`;
  }

  let text = header + results.join("\n");
  output.textContent = text;

  step.style.display="none";
  nextBtn.style.display="none";
  backBtn.style.display="none";
  output.style.display="block";
  copyBtn.style.display="block";
  resetBtn.style.display="block";

  copyBtn.onclick = ()=>navigator.clipboard.writeText(output.textContent);
  resetBtn.onclick = ()=>location.reload();
}
</script>

</body>
</html>